#CI Alert System Notes

![Uatu, The Watcher](http://www.illmosis.net/artwork/uatu2005_color_600p.jpg)

**Uatu, The Watcher**

The CI Alert System is a customizable application and set of features that reacts to events 
generated by a build pipeline, and alerts committers to the state of builds. Alerts can be
via audio announcements, web pages, and by turning devices on and off using **z-wave** and **x10**
control signals. Emails are used to communicate between the build pipeline and the alert system.
The pipeline should be configured to send out emails to an **IMAP**-supported account whenever a 
build breaks, remains broken after another subsequent check-ins, or gets fixed.

##Pre-requisites
You will need **jdk 8**, and **maven 3**.

##Sample Alert System
A sample alert system can be found in the test package **ceri.ci.sample** with resources under
test resource directory **ceri/ci/sample**.

To build and run the sample you will first need to run **mvn install** for the following projects:
- ceri-common
- ceri-rxtx
- ceri-x10
- ceri-zwave

##Setting up Email Processing

To use the email event processor to trigger alerts, configure your CI pipeline (for example Jenkins)
to send emails to an IMAP-supported email account whenever a build event occurs. The email should
have the build name and job name in the subject to help optimize processing times. The state of the
job, and the committer(s) responsible for the state can be in the email body.

You will need to create an `EmailEventParser` to parse the emails, and create an build event for
the alert system to process. The parser should be registered when the alert system is constructed.  

The email processor polls the email account by default every 30 seconds for new events. The property
file configuration should contain the email account credentials, and the IMAP server.


##Setting up Audio Alerts

###Audio files

There is no automated text-to-speech, all audio comes from **wav** files. **mp3** files are not 
currently supported. 50+ sound clips are however included as alert announcements.

The following files are required for phrases:
- phrase/and.wav
- phrase/build.wav
- phrase/by.wav
- phrase/has_just_been_broken.wav
- phrase/is_now_fixed.wav
- phrase/is_still_broken.wav
- phrase/job.wav
- phrase/please_fix_it.wav
- phrase/thank_you.wav
- phrase/thanks_to.wav
- phrase/the_build.wav

Add the following files to add speech for build, job and name alerts:
- build/`build-name`.wav for all build names
- job/`job-name`.wav for all job names
- name/`committer-name`.wav for all names of committers
  
###Downloading speech files
Try these links to generate and download text to speech files:
- http://www2.research.att.com/~ttsweb/tts/demo.php (free, but limited voice types)
- http://www.naturalreaders.com/index.php (more voices; inspect jquery_jplayer_1 div to download content)
- https://acapela-box.com/AcaBox/index.php (cost to download)

The sample files were generated from the AT&T Natural Voices link above. The voice is US English
Lauren.

###Conversion and Normalization
Audio files may need normalization to maintain for consistent volume with sound clips.
**Audacity** is a useful tool to convert **mp3** to **wav**, and to normalize to -3.0db in batches.


##Setting up Z-Wave Alerts

Z-wave alerts turn z-wave devices on for committers who broke a job, and turn them off when a job
is fixed. The alert system works with the VeraLite home automation gateway.

###VeraLite

VeraLite is the home automation gateway used to control the z-wave devices. 

![VeraLite](http://support.mios.com/customer/portal/attachments/72529)

The VeraLite device accepts HTTP commands from the alert system, and sends the signals
over-the-air to the z-wave devices. The devices act as a mesh network to boost transmission
distances. The devices must be paired with the VeraLite, and configured
device ids added to the alert system configuration property file.

###Z-Wave Devices

The z-wave alerts use power on/off signals, supported by devices such as the GE45603 small
appliance module.

![GE45603](http://www.zwaveproducts.com/images/cache/325x396/GE45603-2.jpg)

Small appliances and lights can be plugged into the device to be turned on and off with the
state of the builds.

![Police light](http://thumbs4.ebaystatic.com/d/l225/pict/321382003895_1.jpg)

###Audio Synchronization

Additional device ids may assigned to turn on while the audio alert is active, and turn off when
the audio alert completes. This can be configured in the property file, and specified using an
`AudioListener` with a `ZWaveGroup` during construction of the audio alerter.

##Setting up X10 Alerts

Similar to z-wave, x10 alerts turn x10 devices on for committers who broke a job, and turn them off
when a job is fixed. The alert system works with both the CM17A (Firecracker) and CM11A
transmitter units. A USB to RS232 adapter may be necessary.

![CM17A](http://playground.arduino.cc/uploads/X10/CM17A.png)
![CM11A](http://cache1.smarthome.com/images/1140.jpg)
![USB RS232](http://www.edmdesign.com/Images/USB_adapter.jpg)

The CM17A unit sends signals over the air to a receiver module, which then transmits the x10 signal
through the power line. The CM11A unit sends signals directly to the power line. An appliance module
within the power transmission loop will pick up the signals and turn the power on and off to any
small appliance or light plugged into it.

![Receiver](http://product-images.highwire.com/709479/922608.jpg)
![Appliance module](http://www.authinx.com/pictures/x10_am466_250px.jpg)

**WARNING!** While x10 modules are inexpensive, they are susceptible to noise on the power line,
and signals are blocked by surge supressors. X10 alerts are suitable only for small closed-loop
device clusters.


##Setting up SMS Alerts

SMS alerts send messages to user phone numbers using the Twilio service when a job becomes broken.
A Twilio account is required if this alert is enabled. The configuration is specified in the 
alert property file.

